## 自顶向下微架构分析 {#sec:TMA}

自顶向下微架构分析（TMA）方法论是一种非常强大的技术，用于识别程序中的CPU瓶颈。这是一种健壮且正式的方法论，即使对于没有经验的开发者来说也很容易使用。这种方法论最好的部分是，它不需要开发者对系统中的微架构和性能监控计数器（PMCs）有深入的理解，仍然能够有效地找到CPU瓶颈。

在概念层面上，TMA识别了什么导致了程序执行的停滞。图 @fig:TMA_concept 展示了TMA核心思想的示意图。这并不是实际分析的方式，因为分析每一个微操作（$\mu$op）将会非常缓慢。尽管如此，这个图表有助于理解方法论。

![自顶向下微架构分析顶层分解背后的概念。*© 图片来自 [@TMA_ISPASS]*](../../img/pmu-features/TMAM_diag.png){#fig:TMA_concept width=80%}

以下是如何阅读这个图表的简短指南。正如我们从 [@sec:uarch] 所知，CPU内部有缓冲区，用于跟踪正在执行的$\mu$ops的信息。每当新的指令被获取和解码时，这些缓冲区中就会分配新的条目。如果在某个执行周期中，指令的$\mu$op没有被分配，可能是因为两个原因之一：要么我们无法获取和解码它（`前端瓶颈(Front End Bound)`）；要么后端工作过载，无法为新的$\mu$op分配资源（`后端瓶颈(Back End Bound)`）。如果一个$\mu$op被分配并安排执行但从未退役，这意味着它来自一个错误预测的路径（`错误推测(Bad Speculation)`）。最后，`退役(Retiring)`代表正常执行。这是我们希望所有$\mu$ops所在的桶，尽管稍后我们会讨论一些例外情况。

为了实现其目标，TMA通过监控一组特定的性能事件来观察程序的执行，然后根据预定义的公式计算指标。基于这些指标，TMA通过将其分配到四个高级类别之一来对程序进行特征化。这四个高级类别每个都有若干嵌套级别，CPU厂商可以选择不同的方式来实现。每一代处理器可能有不同的公式来计算这些指标，所以最好依赖工具来进行分析，而不是试图自己计算。

在接下来的章节中，我们将讨论AMD、ARM和Intel处理器中TMA的实现。
